{% extends 'dashboard-base/base.html' %}
{% block content %}
<div class="card-body">
    {% if messages %}
    {% for message in messages %}
    <div>{{ message }}</div>
    {% endfor %}
    {% endif %}

    <button type="submit" class="btn btn-primary">Submit Expense</button>

    <h2>Weekly Total</h2>
    <p>This week's total: {{ demo_weekly_totals|default:"0.00" }}</p>

    <h2>Monthly Total</h2>
    <p>This month's total: {{ demo_monthly_totals|default:"0.00" }}</p>

    <h2>Yearly Total</h2>
    <p>This year's total: {{ demo_yearly_totals|default:"0.00" }}</p>

    <h2>Daily Totals This Week</h2>
    {% for demo_day_total in demo_daily_totals %}
    <p>{{ demo_day_total.day }}: {{ demo_day_total.total|default:"0.00" }}</p>
    {% endfor %}

    <h2>Recent Expenses</h2>
    {% if demo_expenses %}
    <table>
        <tr>
            <th>Date</th>
            <th>Amount</th>
            <th>Description</th>
            <th>Expense</th>
            <th>Action</th>
        </tr>
        {% for demo_day_total in demo_daily_totals %}
        <tr>
            <td>{{ demo_day_total.day }}</td>
            <td>{{ demo_day_total.total|default:"0.00" }}</td>
            <td>{{ demo_day_total.total|default:"0.00" }}</td>
            <td>{{ demo_day_total.total|default:"0.00" }}</td>
            <td>
                <a href="#">Update</a>
                <a href="#">Delete</a>
            </td>
        </tr>
        {% endfor %}
    </table>
    {% else %}
    <p>No expenses recorded.</p>
    {% endif %}
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Get the context of the canvas element we want to select
    const expCtx = document.getElementById('expenseGraph').getContext('2d');
    
    // Create gradients for each section
    const gradientWeekly = expCtx.createLinearGradient(0, 0, 0, 400);
    gradientWeekly.addColorStop(0, 'rgba(33, 150, 243, 1)'); // Start color
    gradientWeekly.addColorStop(1, 'rgba(33, 150, 243, 0.2)'); // End color

    const gradientMonthly = expCtx.createLinearGradient(0, 0, 0, 400);
    gradientMonthly.addColorStop(0, 'rgba(33, 203, 243, 1)');
    gradientMonthly.addColorStop(1, 'rgba(33, 203, 243, 0.2)');

    const gradientYearly = expCtx.createLinearGradient(0, 0, 0, 400);
    gradientYearly.addColorStop(0, 'rgba(13, 71, 161, 1)');
    gradientYearly.addColorStop(1, 'rgba(13, 71, 161, 0.2)');

    // Parsing the Django context variables with null checks
    const expWeekly = parseFloat('{{ weekly_totals.weekly_total }}') || 0;
const expMonthly = parseFloat('{{ monthly_totals.monthly_total }}') || 0;
const expYearly = parseFloat('{{ yearly_totals.yearly_total }}') || 0;
    const expMax = Math.max(expWeekly, expMonthly / 4, expYearly / 52);

    // Normalizing the values, avoiding division by zero
    const normalizedExpWeekly = expMax !== 0 ? (expWeekly / expMax) * 100 : 0;
    const normalizedExpMonthly = expMax !== 0 ? (expMonthly / 4 / expMax) * 100 : 0;
    const normalizedExpYearly = expMax !== 0 ? (expYearly / 52 / expMax) * 100 : 0;

    // Doughnut Chart for Expenses
    const expenseChart = new Chart(expCtx, {
        type: 'doughnut',
        data: {
            labels: ['Weekly', 'Monthly', 'Yearly'],
            datasets: [{
                label: 'Expenditure',
                data: [normalizedExpWeekly, normalizedExpMonthly, normalizedExpYearly],
                backgroundColor: [gradientWeekly, gradientMonthly, gradientYearly],
                borderColor: 'rgba(255, 255, 255, 1)', // White borders for a clean look
                borderWidth: 2 // Adjust border width as needed
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutoutPercentage: 50, // Adjust this value to change the thickness of the doughnut
            legend: {
                labels: {
                    fontColor: 'blue', // Adjust the legend label color to match the theme
                }
            },
            tooltips: {
                enabled: true,
                mode: 'index',
                intersect: false,
                bodyFontColor: 'blue', // Adjust the tooltip font color to match the theme
            },
            animation: {
                animateScale: true,
                animateRotate: true
            }
        }
    });
</script>
{% endblock %}